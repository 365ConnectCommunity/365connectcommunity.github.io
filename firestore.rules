rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- HELPER FUNCTIONS ---

    // Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Check if user is the Super Admin (by email) or has 'admin' role in their profile
    function isAdmin() {
      return isAuthenticated() && (
        request.auth.token.email == 'mianshaheerahmed@gmail.com' || 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin'
      );
    }

    // Check if the user is accessing their own document
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // --- COLLECTION RULES ---

    // 1. Users Collection
    // Public: Read (for Directory)
    // Owner: Update own profile
    // Admin: Create/Update/Delete (for Migration & Management)
    match /users/{userId} {
      allow read: if true;
      allow update: if isOwner(userId);
      allow create, delete: if isAuthenticated(); // Only Admin can create new users (or migration)
      allow write: if isAdmin(); // Catch-all for migration batches
    }

    // 2. Events Collection
    // Public: Read
    // Admin: Create/Update/Delete
    match /events/{eventId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // 3. Team Members Collection
    // Public: Read
    // Admin: Create/Update/Delete
    match /team_members/{memberId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // 4. Social Links (Metadata)
    // Public: Read
    // Admin: Create/Update/Delete
    match /socials/{docId} {
      allow read: if true;
      allow write: if isAdmin();
    }
    match /metadata/{docId} { // Legacy support just in case
        allow read: if true;
        allow write: if isAdmin();
    }

    // 5. Certificates Collection
    // Public: Read (for verification if needed, or restrict to owner?)
    // Owner: Read their own
    // Admin: Full Access
    match /certificates/{certId} {
      allow read: if true; // Public verification often needed, or restrict to isOwner(resource.data.uid)
      allow write: if isAdmin();
    }

    // 6. Registrations Collection
    // Owner: Read/Write own (Email based for legacy/migration, UID for new)
    // Admin: Full Access
    match /registrations/{regId} {
      allow read: if isAdmin() || (isAuthenticated() && (
        resource.data.uid == request.auth.uid || 
        resource.data.email == request.auth.token.email
      ));
      
      allow create: if isAuthenticated() && (
        request.resource.data.uid == request.auth.uid || 
        request.resource.data.email == request.auth.token.email
      );
      
      allow update, delete: if isAdmin() || (isAuthenticated() && (
        resource.data.uid == request.auth.uid || 
        resource.data.email == request.auth.token.email
      ));
      
      allow write: if isAdmin();
    }

    // 7. Contributor Applications
    // Authenticated: Create
    // Admin: Read/Update (Approve/Reject)
    // Owner: Read own
    match /contributor_applications/{appId} {
      allow create: if isAuthenticated();
      allow read: if isAdmin() || (isAuthenticated() && resource.data.uid == request.auth.uid);
      allow update: if isAdmin(); // Only admin approves/rejects
      allow delete: if isAdmin();
    }

    // 8. Course Progress Collection
    // Authenticated: Read/Write own
    // Admin: Full access
    match /course_progress/{progressId} {
      allow read, write: if isAdmin() || (isAuthenticated() && resource.data.uid == request.auth.uid) || (isAuthenticated() && request.resource.data.uid == request.auth.uid);
    }

    // 9. Course Enrollments Collection
    // Authenticated: Read/Write own
    // Admin: Full access
    match /course_enrollments/{enrollmentId} {
      allow read, write: if isAdmin() || (isAuthenticated() && resource.data.uid == request.auth.uid) || (isAuthenticated() && request.resource.data.uid == request.auth.uid);
    }

    // 10. Blogs Collection
    // Public: Read (if status == 'published')
    // Authenticated: Create (contributors)
    // Author: Read/Update (own)
    // Admin: Full Access (Approve/Reject/Edit)
    match /blogs/{blogId} {
      allow read: if (resource.data.status == 'published') || isAdmin() || (isAuthenticated() && resource.data.authorId == request.auth.uid);
      allow create: if isAuthenticated(); // Contributors & Admins
      allow update: if isAdmin() || (isAuthenticated() && resource.data.authorId == request.auth.uid);
      allow delete: if isAdmin() || (isAuthenticated() && resource.data.authorId == request.auth.uid);
    }
  }
}
